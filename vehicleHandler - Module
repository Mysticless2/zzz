--[[
	Vehicle Handler Module
	Handles damage to vehicles and their components (wheels, bulletproof glass, turrets)
]]

local VehicleHandler = {}

-- Vehicle names to search for
-- This table should be populated by the game's initialization script
-- Example: VehicleHandler.Vehicles = {"Tank", "Jeep", "Helicopter"}
VehicleHandler.Vehicles = {}

-- Helper function to search up hierarchy for a specific model name
local function findAncestorByName(instance, nameToFind, substringRange)
	if instance == workspace then return nil end
	
	local parent = instance.Parent
	if not parent then return nil end
	
	local parentName = parent.Name
	if substringRange then
		parentName = string.sub(parentName, substringRange[1], substringRange[2])
	end
	
	if parentName == nameToFind then
		-- Special case for Wheels - return the instance itself
		if nameToFind == "Wheels" then
			return instance
		end
		return parent
	end
	
	-- Special case: if we hit a "Vehicle" model, check for child with target name
	if instance.Name == "Vehicle" and nameToFind ~= "Turret" then
		local targetChild = instance:FindFirstChild(nameToFind)
		if targetChild then
			return targetChild
		end
	end
	
	return findAncestorByName(parent, nameToFind, substringRange)
end

-- Detect if hit part belongs to a vehicle
function VehicleHandler:detectVehicleHit(hitPart)
	if not hitPart or not hitPart.Parent or not hitPart.Parent:IsA("Model") then
		return nil
	end
	
	local vehiclesTable = {}
	
	for _, vehicleName in ipairs(self.Vehicles) do
		local vehicle = findAncestorByName(hitPart, vehicleName)
		if vehicle then
			local vehicleData = {
				Vehicle = vehicle,
				BPG = findAncestorByName(hitPart, "BPG", {1, 3}),
				Wheel = findAncestorByName(hitPart, "Wheels"),
				Turret = findAncestorByName(hitPart, "Turret")
			}
			table.insert(vehiclesTable, vehicleData)
		end
	end
	
	if #vehiclesTable > 0 then
		return vehiclesTable
	end
	
	return nil
end

-- Handle damage to vehicles
function VehicleHandler:handleDamage(hitPart)
	if not hitPart then return end
	
	task.spawn(function()
		local vehiclesTable = self:detectVehicleHit(hitPart)
		if not vehiclesTable then return end
		
		for _, vehicleData in ipairs(vehiclesTable) do
			local vehicle = vehicleData.Vehicle
			local wheel = vehicleData.Wheel
			local bpg = vehicleData.BPG
			local turret = vehicleData.Turret
			
			local stats = vehicle:FindFirstChild("Stats")
			if not stats then continue end
			
			-- Apply health damage
			local health = stats:FindFirstChild("Health")
			if health then
				health.Value = health.Value - 1
			end
			
			-- Apply wheel damage
			local wheelsStats = stats:FindFirstChild("Wheels")
			if wheelsStats and wheel then
				local wheelStat = wheelsStats:FindFirstChild(wheel.Name)
				if wheelStat then
					wheelStat.Value = wheelStat.Value - 1
				end
			end
			
			-- Apply bulletproof glass damage
			local bpgStats = stats:FindFirstChild("BPGlass")
			if bpgStats and bpg then
				local bpgStat = bpgStats:FindFirstChild(bpg.Name)
				if bpgStat then
					bpgStat.Value = bpgStat.Value - 1
				end
			end
			
			-- Apply turret damage
			local turretStat = stats:FindFirstChild("Turret")
			if turretStat and turret then
				turretStat.Value = turretStat.Value - 1
			end
		end
	end)
end

return VehicleHandler
