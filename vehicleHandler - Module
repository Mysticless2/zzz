--[[ AVALLEX 03/07/18 ]]--

local vehicleHandler = {}
	
	vehicleHandler.Vehicles = nil
	function recursiveHieracySearch(instance,nameToFind,sub)
		if instance == workspace then return; end
		local success,retrieve = pcall(function()
			if instance.Parent and (sub and string.sub(instance.Parent.Name,sub[1],sub[2]) or instance.Parent.Name) == nameToFind then
				return ((nameToFind == 'Wheels' and instance) or instance.Parent)
			elseif instance.Name == 'Vehicle' and nameToFind ~= 'Turret' then
				-- if instance.Name == 'Vehicle' | Checks if a vehicle exists when the hitpart is a descendant of the Turret model, which is a sibling to the vehicle name, not a chile
				-- and nameToFind ~= 'Turret' | Makes sure the turret cant be found if the turret search reaches the 'Vehicle' model, as it would detect the turret all the time
				return ((instance:FindFirstChild(nameToFind) and instance[nameToFind]) or recursiveHieracySearch(instance.Parent,nameToFind))
			elseif instance.Parent then
				return recursiveHieracySearch(instance.Parent,nameToFind)
			else
				return
			end
		end)
		if success then return retrieve else warn('Search Failed! - '..tostring(retrieve)) end
	end
	
	function vehicleHandler:detectVehicleHit(hitpart)
		if not hitpart.Parent:IsA('Model') then return end
		local vehiclesTable = {}
		for i,vehicleName in pairs(vehicleHandler.Vehicles) do
			local vehicle = recursiveHieracySearch(hitpart,vehicleName)
			if vehicle then
				local vehicleTable = {Vehicle = vehicle}
				vehicleTable.BPG = recursiveHieracySearch(hitpart,'BPG',{1,3})
				vehicleTable.Wheel = recursiveHieracySearch(hitpart,'Wheels')
				vehicleTable.Turret = recursiveHieracySearch(hitpart,'Turret')
				vehiclesTable[#vehiclesTable+1] = vehicleTable
			end
		end
		if #vehiclesTable > 0 then return vehiclesTable else return; end
	end
	
	function vehicleHandler:handleDamage(hitPart)
		coroutine.resume(coroutine.create(function(hitpart)
			local vehiclesTable = vehicleHandler:detectVehicleHit(hitPart)
			if vehiclesTable then
				for i,vehicleTable in pairs(vehiclesTable) do
					local Vehicle = vehicleTable.Vehicle
					local Wheel = vehicleTable.Wheel
					local BPG = vehicleTable.BPG
					local Turret = vehicleTable.Turret
					local Stats = Vehicle:FindFirstChild('Stats')
					if Stats then
						if Stats:FindFirstChild('Health') then
							Stats.Health.Value = Stats.Health.Value - 1
						end
						if Stats:FindFirstChild('Wheels') and Wheel then
							Stats.Wheels[Wheel.Name].Value = Stats.Wheels[Wheel.Name].Value - 1
						end
						if Stats:FindFirstChild('BPGlass') and BPG then
							Stats.BPGlass[BPG.Name].Value = Stats.BPGlass[BPG.Name].Value - 1
						end
						if Stats:FindFirstChild('Turret') and Turret then
							Stats.Turret.Value = Stats.Turret.Value - 1
						end
					end
				end
				vehiclesTable = nil
			end
		end),hitPart)
	end

return vehicleHandler
