--[[
	Firearm Handler Module
	Handles server-side weapon firing, damage calculation, and effects
]]

local FirearmHandler = {}

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")

-- Load firearm stats
local firearmStats = require(ReplicatedStorage:WaitForChild("firearmsModules"):WaitForChild("firearmStats"))

-- Load sub-modules
local objectHandler = require(script:FindFirstChild("objectHandler"))
local vehicleHandler = require(script:FindFirstChild("vehicleHandler"))

-- Network
local NetworkFolder = ReplicatedStorage:WaitForChild("firearmsNetwork")
local RE = NetworkFolder:WaitForChild("RE")

-- Constants
local DAMAGE_MULTIPLIERS = {
	Head = 2,
	Torso = 1.5,
	UpperTorso = 1.5,
	LowerTorso = 1.25,
}

-- Helper function to find humanoid from hit part
local function findHumanoidFromPart(hitPart)
	if not hitPart then return nil end
	
	local parent = hitPart.Parent
	if parent then
		-- Check if hit an accessory first
		if parent:IsA("Accessory") then
			local handle = parent:FindFirstChild("Handle")
			if handle then
				local weld = handle:FindFirstChild("AccessoryWeld")
				if weld and weld.Part1 then
					parent = weld.Part1.Parent
				end
			end
		end
		
		-- Try to find humanoid in parent or grandparent
		local humanoid = parent:FindFirstChildOfClass("Humanoid")
		if not humanoid and parent.Parent then
			humanoid = parent.Parent:FindFirstChildOfClass("Humanoid")
		end
		
		return humanoid, parent
	end
	
	return nil
end

-- Handle muzzle flash and sound effects
local function playFireEffects(tool, isBoltAction)
	local barrelEnd = tool:FindFirstChild("BarrelEnd")
	
	if barrelEnd then
		-- Enable flash effects
		local flash = barrelEnd:FindFirstChild("Flash")
		local flashFX = barrelEnd:FindFirstChild("FlashFX")
		local smoke = barrelEnd:FindFirstChild("Smoke")
		
		if flash then flash.Enabled = true end
		if flashFX then flashFX.Enabled = true end
		if smoke then smoke.Enabled = true end
		
		-- Disable after brief delay
		task.delay(0.05, function()
			if flash then flash.Enabled = false end
			if flashFX then flashFX.Enabled = false end
			if smoke then smoke.Enabled = false end
		end)
	end
	
	-- Play fire sound with slight pitch variation
	local handle = tool:FindFirstChild("Handle")
	if handle then
		local fireSound = handle:FindFirstChild("Fire")
		if fireSound then
			local newSound = fireSound:Clone()
			newSound.PlaybackSpeed = 1 + (math.random(-10, 10) / 100)
			newSound.Parent = handle
			newSound:Play()
			
			newSound.Ended:Once(function()
				newSound:Destroy()
			end)
		end
		
		-- Play bolt action sound after delay
		if isBoltAction then
			task.delay(1, function()
				local primeSound = handle:FindFirstChild("Prime")
				if primeSound then
					primeSound:Play()
				end
			end)
		end
	end
end

-- Replicate trail effect to other players
local function replicateTrailEffect(firingPlayer, tool, hitPosition)
	local flameAttachment = tool:FindFirstChild("Flame")
	if not flameAttachment then return end
	
	local attachment = flameAttachment:FindFirstChild("Attachment")
	if not attachment then return end
	
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= firingPlayer then
			RE:FireClient(player, "renderTrail", attachment, hitPosition)
		end
	end
end

-- Apply damage to humanoid
local function applyDamage(humanoid, hitPart, baseDamage)
	if not humanoid or humanoid.Health <= 0 then return end
	
	local damageMultiplier = DAMAGE_MULTIPLIERS[hitPart.Name] or 1
	local finalDamage = baseDamage * damageMultiplier
	
	humanoid:TakeDamage(finalDamage)
end

-- Handle object/vehicle damage
local function handleEnvironmentDamage(hitPart)
	if objectHandler then
		objectHandler:handleDamage(hitPart)
	end
	if vehicleHandler then
		vehicleHandler:handleDamage(hitPart)
	end
end

-- Main fire weapon function
function FirearmHandler:fireWeapon(player, ...)
	local args = {...}
	local character = args[1]
	local hitPart = args[2]
	local hitPosition = args[3]
	local isBoltAction = args[4] or false
	
	-- Validate player and character
	if not player or not player.Character then return end
	if character ~= player.Character then
		player:Kick("Character mismatch detected")
		return
	end
	
	local tool = character:FindFirstChildOfClass("Tool")
	if not tool then return end
	
	local stats = firearmStats[tool.Name]
	if not stats then
		warn(string.format("[FirearmHandler] No stats found for weapon: %s", tool.Name))
		return
	end
	
	-- Play effects asynchronously
	task.spawn(playFireEffects, tool, isBoltAction)
	
	-- Replicate trail to other players
	task.spawn(replicateTrailEffect, player, tool, hitPosition)
	
	-- Process hit
	if hitPart then
		local humanoid, hitParent = findHumanoidFromPart(hitPart)
		
		if humanoid then
			applyDamage(humanoid, hitPart, stats.Damage)
		else
			handleEnvironmentDamage(hitPart)
		end
	end
end

return FirearmHandler
